{% extends "base.html" %}

{% block title %}IGECH TECH ‚Äî Meus Servi√ßos{% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/meus_servicos.css') }}">
{% endblock %}

{% block content %}
<main class="main-meus-servicos">
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">üìã Meus Servi√ßos</h1>
        <p class="page-subtitle">Acompanhe todos os servi√ßos que voc√™ contratou</p>
    </div>

    <!-- Estat√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total de Servi√ßos</div>
            <div class="stat-value">{{ total_servicos }}</div>
        </div>
        <div class="stat-card abertos">
            <div class="stat-label">Abertos</div>
            <div class="stat-value">{{ abertos }}</div>
        </div>
        <div class="stat-card em-andamento">
            <div class="stat-label">Em Andamento</div>
            <div class="stat-value">{{ em_andamento }}</div>
        </div>
        <div class="stat-card concluidos">
            <div class="stat-label">Conclu√≠dos</div>
            <div class="stat-value">{{ concluidos }}</div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label for="filtroStatus">Filtrar por Status:</label>
                <select id="filtroStatus" class="filter-select" onchange="filtrarServicos()">
                    <option value="todos">Todos os status</option>
                    <option value="aberta">Abertos</option>
                    <option value="em andamento">Em Andamento</option>
                    <option value="concluida">Conclu√≠dos</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filtroCategoria">Filtrar por Categoria:</label>
                <select id="filtroCategoria" class="filter-select" onchange="filtrarServicos()">
                    <option value="todos">Todas as categorias</option>
                    <option value="Hardware">Hardware</option>
                    <option value="Software">Software</option>
                    <option value="Redes">Redes</option>
                    <option value="Suporte">Suporte</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Lista de Servi√ßos -->
    <div class="servicos-lista" id="servicosLista">
        {% if servicos %}
            {% for servico in servicos %}
            <div class="servico-card status-{{ servico.status.replace(' ', '-') }}"
                 data-status="{{ servico.status }}"
                 data-categoria="{{ servico.categoria }}">

                <div class="servico-header">
                    <div class="servico-protocolo">üé´ Protocolo #{{ servico.protocolo }}</div>
                    <div class="servico-badges">
                        <span class="badge status-{{ servico.status.replace(' ', '-') }}">
                            {{ servico.status }}
                        </span>
                        <span class="badge prioridade-{{ servico.prioridade }}">
                            {{ servico.prioridade }}
                        </span>
                    </div>
                </div>

                <div class="servico-body">
                    <div class="servico-info-grid">
                        <div class="info-item">
                            <div class="info-icon">üõ†Ô∏è</div>
                            <div class="info-content">
                                <div class="info-label">Categoria</div>
                                <div class="info-value">{{ servico.categoria }}</div>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-icon">üìÖ</div>
                            <div class="info-content">
                                <div class="info-label">Data de Abertura</div>
                                <div class="info-value">{{ servico.data_abertura.strftime('%d/%m/%Y') }}</div>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-icon">‚è∞</div>
                            <div class="info-content">
                                <div class="info-label">Prazo Estimado</div>
                                <div class="info-value">{{ servico.prazo_estimado.strftime('%d/%m/%Y') if servico.prazo_estimado else 'N√£o definido' }}</div>
                            </div>
                        </div>

                        {% if servico.nome_tecnico %}
                        <div class="info-item">
                            <div class="info-icon">üë®‚Äçüíª</div>
                            <div class="info-content">
                                <div class="info-label">T√©cnico Respons√°vel</div>
                                <div class="info-value">{{ servico.nome_tecnico }}{% if servico.nivel_experiencia %} - {{ servico.nivel_experiencia }}{% endif %}</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if servico.endereco_atendimento %}
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-icon">üìç</div>
                            <div class="info-content">
                                <div class="info-label">Endere√ßo de Atendimento</div>
                                <div class="info-value">{{ servico.endereco_atendimento }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="problema-texto">
                        <strong>Descri√ß√£o do Problema:</strong>
                        {{ servico.problema }}
                    </div>

                    <!-- Bot√£o de avaliar para servi√ßos conclu√≠dos -->
                    {% if servico.status == 'concluida' and servico.nome_tecnico %}
                    <div style="margin-top: 16px;">
                        <button class="btn-avaliar" onclick="abrirModalAvaliacao({{ servico.protocolo }}, '{{ servico.nome_tecnico }}', {{ servico.avaliacao_usuario if servico.avaliacao_usuario else 'null' }})">
                            {% if servico.avaliacao_usuario %}
                                ‚≠ê Editar Avalia√ß√£o ({{ servico.avaliacao_usuario }}/5.0)
                            {% else %}
                                ‚≠ê Avaliar Servi√ßo
                            {% endif %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h2 class="empty-state-title">Nenhum servi√ßo contratado ainda</h2>
                <p class="empty-state-text">Voc√™ ainda n√£o contratou nenhum servi√ßo. Que tal come√ßar agora?</p>
                <a href="{{ url_for('pagina.contratar_servico') }}" class="btn-primary">
                    üöÄ Contratar Servi√ßo
                </a>
            </div>
        {% endif %}
    </div>
</main>

<!-- Modal de Avalia√ß√£o -->
<div id="modalAvaliacao" class="modal-overlay" style="display: none;" aria-hidden="true">
    <div class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚≠ê Avaliar Servi√ßo</h2>
                <button class="modal-close" onclick="fecharModalAvaliacao()" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formAvaliacao" onsubmit="enviarAvaliacao(event)">
                    <input type="hidden" id="protocoloAvaliacao">

                    <div class="form-group">
                        <label>T√©cnico:</label>
                        <div id="nomeTecnicoAvaliacao" style="font-weight: 600; color: var(--azul-royal); font-size: 1.1rem;"></div>
                    </div>

                    <div class="form-group">
                        <label for="notaAvaliacao">‚≠ê Nota (0.5 a 5.0): *</label>
                        <div class="rating-input">
                            <input type="range" id="notaAvaliacao" min="0.5" max="5" step="0.5" value="5" oninput="atualizarEstrelasAvaliacao(this.value)">
                            <div class="rating-display">
                                <span id="estrelasVisuais" class="estrelas-grandes">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                <span id="notaTexto" class="nota-texto">5.0</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="comentarioAvaliacao">üí¨ Coment√°rio (opcional):</label>
                        <textarea id="comentarioAvaliacao" rows="4" placeholder="Conte como foi sua experi√™ncia com o t√©cnico..."></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="fecharModalAvaliacao()">Cancelar</button>
                        <button type="submit" class="btn-primary">‚úÖ Enviar Avalia√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
  <script src="{{ url_for('static', filename='js/modals.js') }}"></script>
  <script src="{{ url_for('static', filename='js/meus_servicos.js') }}"></script>
{% endblock %}
