<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}IGECH TECH{% endblock %}</title>

  <!-- CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css', v=1) }}"/>
  <!-- CSS de Alertas -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/alerts.css') }}"/>

  {% block page_css %}{% endblock %}
</head>

<body>

<div id="particles-bg" aria-hidden="true"></div>

<header>
  <div class="logo">
    <a href="{{ url_for('home') }}" class="brand">IGECH <span class="accent">TECH</span></a>
  </div>

  <nav class="site-nav">
    <button class="hamburger" id="hamburger" aria-label="Abrir menu"
            aria-expanded="false" aria-controls="mainMenu">
      <span></span><span></span><span></span>
    </button>

    <ul id="mainMenu" class="menu">
      {% if session.get('admin') %}
        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li><a href="{{ url_for('empresas') }}">Empresas</a></li>
        <li><a href="{{ url_for('tecnicos') }}">T√©cnicos</a></li>
        <li><a href="{{ url_for('usuarios') }}">Usu√°rios</a></li>
        <li><a href="{{ url_for('alocacoes') }}">Aloca√ß√µes</a></li>
        <li><a href="{{ url_for('servicos') }}">Servi√ßos</a></li>
      {% elif session.get('usuario_id') %}
        <li><a href="{{ url_for('contratar_servico') }}" class="menu-destaque">üõ†Ô∏è Contratar Servi√ßo</a></li>
        <li><a href="{{ url_for('servicos') }}">Meus Servi√ßos</a></li>
      {% else %}
        <li><a href="{{ url_for('contratar_servico') }}" class="menu-destaque">üõ†Ô∏è Contratar Servi√ßo</a></li>
      {% endif %}
      <li><a href="{{ url_for('sobre_nos') }}">Sobre N√≥s</a></li>
      <li><a href="{{ url_for('ajuda') }}">Ajuda</a></li>
    </ul>
  </nav>

  <div class="top-user">
    {% if not session.get('usuario_id') %}
      <button id="btnLogin" class="btn" type="button" data-open="modalLogin">Login</button>
      <button id="btnCadastro" class="btn" type="button" data-open="modalCadastro">Cadastro</button>
    {% else %}
      <span class="user-badge" aria-hidden="true"></span>
      <span class="user-name">{{ session.get('usuario_nome') }}</span>
      <a href="{{ url_for('logout') }}" id="btnLogout" class="btn-link">Sair</a>
    {% endif %}
  </div>
</header>

<main id="main" class="main">
  <div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            <span class="alert-icon">
              {% if category == 'success' %}‚úì{% endif %}
              {% if category == 'danger' or category == 'error' %}‚úó{% endif %}
              {% if category == 'warning' %}‚ö†{% endif %}
              {% if category == 'info' %}‚Ñπ{% endif %}
            </span>
            <span class="alert-message">{{ message }}</span>
            <button class="alert-close">&times;</button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  {% block content %}{% endblock %}
</main>

<footer>
  <p>2025 IGECH TECH ‚Äî Todos os direitos reservados.</p>
</footer>

<!-- ===================== MODAL LOGIN ===================== -->
<div id="modalLogin" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true"
       aria-labelledby="loginTitle" aria-describedby="loginDesc">
    <button type="button" class="close" aria-label="Fechar">&times;</button>

    <h2 id="loginTitle">Login</h2>
    <p id="loginDesc" class="sr-only">
      Entre com seu e-mail e senha para acessar o sistema.
    </p>

    <form method="POST" action="{{ url_for('login') }}">
      <label for="login_email">Email</label>
      <input type="email" id="login_email" name="email" required autocomplete="username"/>

      <label for="login_senha">Senha</label>
      <input type="password" id="login_senha" name="senha" required autocomplete="current-password"/>

      <button type="submit" class="btn">Entrar</button>

      <p class="modal-switch">
        N√£o tem conta?
        <button type="button" class="btn-link" data-switch="modalCadastro">
          Criar conta
        </button>
      </p>
    </form>
  </div>
</div>

<!-- ===================== MODAL CADASTRO ===================== -->
<div id="modalCadastro" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true"
       aria-labelledby="cadastroTitle" aria-describedby="cadastroDesc">
    <button type="button" class="close" aria-label="Fechar">&times;</button>

    <h2 id="cadastroTitle">Cadastro</h2>
    <p id="cadastroDesc" class="sr-only">
      Informe seus dados para criar uma conta.
    </p>

    <!-- CORRIGIDO: usa endpoint que existe (ajuste se quiser outro) -->
    <form id="formCadastro" method="POST" action="{{ url_for('usuario.api_usuario_criar') }}">
      <label for="cadastro_nome">Nome</label>
      <input type="text" id="cadastro_nome" name="nome" required />

      <label for="cadastro_email">Email</label>
      <input type="email" id="cadastro_email" name="email" required autocomplete="email"/>

      <label for="cadastro_senha">Senha</label>
      <input type="password" id="cadastro_senha" name="senha" required autocomplete="new-password"/>

      <label for="cadastro_telefone">Telefone</label>
      <input type="tel" id="cadastro_telefone" name="telefone" required />

      <!-- Campos de empresa esperados pelo modals.js -->
      <label for="cadastro_empresa_cnpj">CNPJ da empresa</label>
      <input type="text" id="cadastro_empresa_cnpj" name="empresa_cnpj"
             placeholder="00.000.000/0000-00" />
      <small id="cnpj_status"></small>

      <div id="campo_nome_empresa" style="display:none;">
        <label for="cadastro_empresa_nome">Nome da empresa</label>
        <input type="text" id="cadastro_empresa_nome" name="empresa_nome"/>
      </div>

      <div id="campo_email_empresa" style="display:none;">
        <label for="cadastro_empresa_email">Email da empresa</label>
        <input type="email" id="cadastro_empresa_email"
               name="empresa_email_manual"/>
      </div>

      <div id="dados_empresa_encontrada" style="display:none; margin-top:.5rem;">
        <div id="empresa_info"></div>
      </div>

      <button type="submit" class="btn">Registrar</button>

      <p class="modal-switch">
        J√° tem conta?
        <button type="button" class="btn-link" data-switch="modalLogin">
          Entrar
        </button>
      </p>
    </form>
  </div>
</div>

<!-- ============== JS GLOBAL ============== -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  const hamburger = document.querySelector('.hamburger');
  const menu = document.querySelector('.menu');

  if (hamburger && menu) {
    hamburger.addEventListener('click', function() {
      menu.classList.toggle('open');
    });

    document.addEventListener('click', function(e) {
      if (!hamburger.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('open');
      }
    });

    const menuLinks = menu.querySelectorAll('a');
    menuLinks.forEach(link => {
      link.addEventListener('click', function() {
        menu.classList.remove('open');
      });
    });
  }
});
</script>

<script>
(function() {
  'use strict';

  function closeFlash(btn) {
    var flash = btn.parentElement;
    flash.style.opacity = '0';
    flash.style.transform = 'translateY(-10px)';
    setTimeout(function() {
      flash.remove();
    }, 300);
  }

  function autoCloseFlash(flash) {
    setTimeout(function() {
      flash.style.opacity = '0';
      flash.style.transform = 'translateY(-10px)';
      setTimeout(function() {
        flash.remove();
      }, 300);
    }, 5000);
  }

  window.addEventListener('load', function() {
    var closeButtons = document.querySelectorAll('.alert-close');
    for (var i = 0; i < closeButtons.length; i++) {
      (function(btn) {
        btn.addEventListener('click', function() {
          closeFlash(btn);
        });
      })(closeButtons[i]);
    }

    var flashes = document.querySelectorAll('.alert');
    for (var j = 0; j < flashes.length; j++) {
      autoCloseFlash(flashes[j]);
    }
  });
})();
</script>

<script src="https://unpkg.com/imask"></script>
<script src="{{ url_for('static', filename='js/masks.js') }}"></script>

<script src="{{ url_for('static', filename='js/alerts.js', v=2) }}"></script>
<script src="{{ url_for('static', filename='js/modals.js', v=3) }}"></script>

<script src="https://bots.easy-peasy.ai/chat.min.js" data-chat-url="https://bots.easy-peasy.ai/bot/8a13ab86-bb82-4ce8-96c5-81f5d57e1481" data-btn-position="bottom-right" data-widget-btn-color="#3b8cff" defer>¬†</script>

{% block page_js %}{% endblock %}

</body>
</html>
